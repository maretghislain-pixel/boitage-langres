<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>PAP et Boitage Langres</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
 
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
 
<!-- FIREBASE COMPAT -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
 
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: Arial, sans-serif;
}
 
#map {
  height: 100vh;
  width: 100vw;
}
 
.panel {
  position: fixed;
  top: 10px;
  left: 50px;
  z-index: 1000;
  background: white;
  padding: 12px;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.25);
  width: 210px;
}
 
.loading {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 15px 20px;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.3);
  z-index: 2000;
  font-size: 15px;
}
 
.hidden { display: none; }
 
.legend {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}
 
.dot {
  height: 12px;
  width: 12px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 5px;
}
 
.red { background: red; }
.blue { background: blue; }
 
.btn {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  font-size: 15px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  color: white;
}
 
.center-btn { background: #1e88e5; }
.reset-btn { background: #e53935; }
</style>
</head>
 
<body>
 
<div class="panel">
  <h3>PAP et Boitage Langres</h3>
  <div class="legend">
    <div><span class="dot red"></span>√Ä faire</div>
    <div><span class="dot blue"></span>Fait</div>
  </div>
  <button class="btn center-btn" onclick="centerMe()">üìç Me centrer</button>
  <button class="btn reset-btn" onclick="resetAll()">üîÑ R√©initialiser</button>
</div>
 
<div id="loading" class="loading">
  ‚è≥ Chargement des rues‚Ä¶
</div>
 
<div id="map"></div>
 
<script>
/* üî• FIREBASE ‚Äî LANGRES */
firebase.initializeApp({
  apiKey: "AIzaSyCfwzQCZ10qwRufMOjKaGp3_DpiXhG46pY",
  authDomain: "boitage-langres.firebaseapp.com",
  databaseURL: "https://boitage-langres-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "boitage-langres",
  storageBucket: "boitage-langres.appspot.com",
  messagingSenderId: "1085978833930",
  appId: "1:1085978833930:web:f2559d4af228680fc29bf3"
});
 
const db = firebase.database();
 
/* üìç LANGRES */
const LANGRES = [47.8625, 5.3333];
const RADIUS_METERS = 4000;
const RESET_CODE = "2807";
 
/* üó∫Ô∏è CARTE */
const map = L.map('map').setView(LANGRES, 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);
 
/* üöÄ CHARGEMENT DES RUES (FIABLE) */
let attempts = 0;
 
function loadStreets() {
  attempts++;
 
  fetch("https://overpass-api.de/api/interpreter", {
    method: "POST",
    body: `
    [out:json][timeout:25];
    (
      way["highway"](around:${RADIUS_METERS},${LANGRES[0]},${LANGRES[1]});
    );
    out geom tags;
    `
  })
  .then(r => r.json())
  .then(data => {
    if (!data.elements || data.elements.length === 0) {
      throw "Donn√©es vides";
    }
 
    document.getElementById("loading").classList.add("hidden");
 
    data.elements.forEach(el => {
      if (!el.geometry) return;
 
      const id = el.id;
      const name = el.tags && el.tags.name ? el.tags.name : "Rue sans nom";
      const coords = el.geometry.map(p => [p.lat, p.lon]);
 
      /* üëÅÔ∏è LIGNE VISIBLE */
      const visibleLine = L.polyline(coords, {
        color: "red",
        weight: 3,
        opacity: 0.75
      }).addTo(map);
 
      /* üëÜ ZONE DE CLIC LARGE (INVISIBLE) */
      const clickLine = L.polyline(coords, {
        weight: 18,
        opacity: 0
      }).addTo(map);
 
      db.ref("streets/" + id).on("value", snap => {
        visibleLine.setStyle({
          color: snap.exists() ? snap.val() : "red",
          opacity: 0.75
        });
      });
 
      clickLine.on("click", () => {
        const next = visibleLine.options.color === "red" ? "blue" : "red";
        db.ref("streets/" + id).set(next);
      });
    });
  })
  .catch(() => {
    if (attempts < 3) {
      setTimeout(loadStreets, 1500);
    } else {
      document.getElementById("loading").innerText =
        "‚ùå Probl√®me de chargement. V√©rifiez votre connexion.";
    }
  });
}
 
/* ‚è±Ô∏è D√âMARRAGE */
map.whenReady(loadStreets);
 
/* üîÑ RESET S√âCURIS√â */
function resetAll() {
  const code = prompt("Code de r√©initialisation :");
  if (code !== RESET_CODE) {
    alert("‚ùå Code incorrect");
    return;
  }
 
  if (confirm("‚ö†Ô∏è R√©initialiser toutes les rues pour toute l‚Äô√©quipe ?")) {
    db.ref("streets").set({});
  }
}
 
/* üìç GPS */
function centerMe() {
  navigator.geolocation.getCurrentPosition(pos => {
    map.setView([pos.coords.latitude, pos.coords.longitude], 16);
  });
}
</script>
 
</body>
</html>
 
